<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:R3Ext.SampleApp.ViewModels"
             x:Class="R3Ext.SampleApp.WhenObservedPage"
             Title="WhenObserved">
    <ContentPage.BindingContext>
        <vm:WhenObservedViewModel />
    </ContentPage.BindingContext>
    <ScrollView>
        <VerticalStackLayout Padding="20"
                             Spacing="20">
            <!-- Header -->
            <Label Text="WhenObserved Operator"
                   FontSize="24"
                   FontAttributes="Bold" />
            <Label Text="WhenObserved observes properties that return IObservable&lt;T&gt; and automatically switches between them when the property changes. Similar to ReactiveUI's WhenAnyObservable."
                   FontSize="14"
                   TextColor="Gray" />

            <!-- Example 1: Simple Observable Property -->
            <Frame BorderColor="LightGray"
                   Padding="15"
                   CornerRadius="8">
                <VerticalStackLayout Spacing="10">
                    <Label Text="Example 1: Document Save Status"
                           FontSize="18"
                           FontAttributes="Bold" />
                    <Label Text="Observes: CurrentDocument.IsSaved (Observable&lt;bool&gt;)"
                           FontSize="12"
                           TextColor="Gray" />
                    <BoxView HeightRequest="1"
                             Color="LightGray"
                             Margin="0,5" />
                    <Label Text="{Binding ObservedDocumentStatus}"
                           FontSize="16"
                           FontAttributes="Bold"
                           TextColor="Blue" />
                    <HorizontalStackLayout Spacing="10">
                        <Button Text="Trigger Save"
                                Command="{Binding TriggerDocumentSaveCommand}"
                                Clicked="OnTriggerDocumentSave" />
                        <Button Text="Trigger Edit"
                                Command="{Binding TriggerDocumentEditCommand}"
                                Clicked="OnTriggerDocumentEdit" />
                    </HorizontalStackLayout>
                    <Button Text="Switch to New Document"
                            Command="{Binding SwitchToNewDocumentCommand}"
                            Clicked="OnSwitchToNewDocument"
                            BackgroundColor="DarkOrange" />
                </VerticalStackLayout>
            </Frame>

            <!-- Example 2: Data Stream -->
            <Frame BorderColor="LightGray"
                   Padding="15"
                   CornerRadius="8">
                <VerticalStackLayout Spacing="10">
                    <Label Text="Example 2: Data Stream Values"
                           FontSize="18"
                           FontAttributes="Bold" />
                    <Label Text="Observes: CurrentStream.DataObservable (Observable&lt;int&gt;)"
                           FontSize="12"
                           TextColor="Gray" />
                    <BoxView HeightRequest="1"
                             Color="LightGray"
                             Margin="0,5" />
                    <Label Text="{Binding ObservedStreamValue}"
                           FontSize="16"
                           FontAttributes="Bold"
                           TextColor="Green" />
                    <HorizontalStackLayout Spacing="10">
                        <Button Text="Emit Random Value"
                                Command="{Binding EmitStreamValueCommand}"
                                Clicked="OnEmitStreamValue" />
                        <Button Text="Switch to New Stream"
                                Command="{Binding SwitchToNewStreamCommand}"
                                Clicked="OnSwitchToNewStream"
                                BackgroundColor="DarkOrange" />
                    </HorizontalStackLayout>
                </VerticalStackLayout>
            </Frame>

            <!-- Example 3: Nested Property -->
            <Frame BorderColor="LightGray"
                   Padding="15"
                   CornerRadius="8">
                <VerticalStackLayout Spacing="10">
                    <Label Text="Example 3: Nested Observable"
                           FontSize="18"
                           FontAttributes="Bold" />
                    <Label Text="Observes: NestedContainer.Document.IsSaved (nested chain)"
                           FontSize="12"
                           TextColor="Gray" />
                    <BoxView HeightRequest="1"
                             Color="LightGray"
                             Margin="0,5" />
                    <Label Text="{Binding ObservedNestedValue}"
                           FontSize="16"
                           FontAttributes="Bold"
                           TextColor="Purple" />
                    <Button Text="Switch Nested Document"
                            Command="{Binding SwitchNestedDocumentCommand}"
                            Clicked="OnSwitchNestedDocument"
                            BackgroundColor="DarkOrange" />
                </VerticalStackLayout>
            </Frame>

            <!-- Event Log -->
            <Frame BorderColor="LightGray"
                   Padding="15"
                   CornerRadius="8">
                <VerticalStackLayout Spacing="10">
                    <HorizontalStackLayout Spacing="10"
                                           HorizontalOptions="FillAndExpand">
                        <Label Text="Event Log"
                               FontSize="18"
                               FontAttributes="Bold"
                               HorizontalOptions="StartAndExpand" />
                        <Button Text="Clear"
                                Command="{Binding ClearLogCommand}"
                                Clicked="OnClearLog"
                                BackgroundColor="Red"
                                TextColor="White"
                                Padding="10,5"
                                FontSize="12" />
                    </HorizontalStackLayout>
                    <BoxView HeightRequest="1"
                             Color="LightGray"
                             Margin="0,5" />
                    <CollectionView ItemsSource="{Binding EventLog}"
                                    HeightRequest="300">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Label Text="{Binding .}"
                                       FontSize="12"
                                       FontFamily="Courier"
                                       Padding="5,2" />
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Frame>

            <!-- Key Points -->
            <Frame BorderColor="LightBlue"
                   BackgroundColor="#E3F2FD"
                   Padding="15"
                   CornerRadius="8">
                <VerticalStackLayout Spacing="5">
                    <Label Text="Key Points:"
                           FontSize="16"
                           FontAttributes="Bold" />
                    <Label Text="• WhenObserved automatically switches subscriptions when the observable property changes"
                           FontSize="12" />
                    <Label Text="• Old subscriptions are disposed when switching to new observables"
                           FontSize="12" />
                    <Label Text="• Works with property chains (e.g., Container.Document.IsSaved)"
                           FontSize="12" />
                    <Label Text="• Uses INPC when available, falls back to polling for plain objects"
                           FontSize="12" />
                    <Label Text="• Handles null intermediates gracefully"
                           FontSize="12" />
                </VerticalStackLayout>
            </Frame>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
